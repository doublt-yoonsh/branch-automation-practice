name: Create Branch from Issue

on:
  issues:
    types: [labeled]

jobs:
  create-branch:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch info
        id: branch-info
        run: |
          LABEL="${{ github.event.label.name }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          case "$LABEL" in
            feat|fix)
              echo "branch_name=feat/${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
              echo "base_branch=dev" >> $GITHUB_OUTPUT
              echo "target_branch=dev" >> $GITHUB_OUTPUT
              echo "should_create=true" >> $GITHUB_OUTPUT
              ;;
            hotfix)
              echo "branch_name=hotfix/${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
              echo "base_branch=main" >> $GITHUB_OUTPUT
              echo "target_branch=main" >> $GITHUB_OUTPUT
              echo "should_create=true" >> $GITHUB_OUTPUT
              ;;
            ci|cd)
              echo "branch_name=config/${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
              echo "base_branch=main" >> $GITHUB_OUTPUT
              echo "target_branch=main" >> $GITHUB_OUTPUT
              echo "should_create=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "should_create=false" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Check if branch already exists
        if: steps.branch-info.outputs.should_create == 'true'
        id: check-branch
        run: |
          BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create branch
        if: steps.branch-info.outputs.should_create == 'true' && steps.check-branch.outputs.exists == 'false'
        run: |
          BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
          BASE_BRANCH="${{ steps.branch-info.outputs.base_branch }}"

          git checkout "$BASE_BRANCH"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

      - name: Generate PR URL
        if: steps.branch-info.outputs.should_create == 'true' && steps.check-branch.outputs.exists == 'false'
        id: pr-url
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
          TARGET_BRANCH="${{ steps.branch-info.outputs.target_branch }}"
          REPO="${{ github.repository }}"

          # URL encode the title and body
          ENCODED_TITLE=$(echo "$ISSUE_TITLE" | sed 's/ /%20/g' | sed 's/#/%23/g' | sed 's/:/%3A/g')
          PR_BODY="Closes%20%23${ISSUE_NUMBER}"

          PR_URL="https://github.com/${REPO}/compare/${TARGET_BRANCH}...${BRANCH_NAME}?expand=1&title=${ENCODED_TITLE}&body=${PR_BODY}"

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT

      - name: Comment on issue (branch created)
        if: steps.branch-info.outputs.should_create == 'true' && steps.check-branch.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.branch-info.outputs.branch_name }}';
            const baseBranch = '${{ steps.branch-info.outputs.base_branch }}';
            const targetBranch = '${{ steps.branch-info.outputs.target_branch }}';
            const prUrl = '${{ steps.pr-url.outputs.pr_url }}';
            const issueNumber = context.issue.number;
            const actor = context.actor;

            const needsBackmerge = targetBranch === 'main';
            const backmergeNote = needsBackmerge
              ? '\n- ë¨¸ì§€ í›„ `main` â†’ `dev` ë°±ë¨¸ì§€ê°€ ì§„í–‰ë©ë‹ˆë‹¤'
              : '';

            const body = `ğŸ‘‹ @${actor}

            âœ… ë¸Œëœì¹˜ \`${branchName}\`ê°€ \`${baseBranch}\` ë¸Œëœì¹˜ë¡œë¶€í„° ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!

            ### ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„:
            1. ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ: \`git fetch && git checkout ${branchName}\`
            2. ì‘ì—… ì™„ë£Œ í›„ [PR ìƒì„±í•˜ê¸°](${prUrl})

            ### ğŸ’¡ PR ìƒì„± ì‹œ ìë™ìœ¼ë¡œ:
            - ì´ìŠˆ #${issueNumber}ì™€ ì—°ê²°ë©ë‹ˆë‹¤
            - \`${targetBranch}\` ë¸Œëœì¹˜ë¡œ ë¨¸ì§€ë©ë‹ˆë‹¤
            - ë¨¸ì§€ ì‹œ ì´ìŠˆê°€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤
            - ë¸Œëœì¹˜ê°€ ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤${backmergeNote}`;

            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on issue (branch already exists)
        if: steps.branch-info.outputs.should_create == 'true' && steps.check-branch.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.branch-info.outputs.branch_name }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âš ï¸ ë¸Œëœì¹˜ \`${branchName}\`ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\nì²´í¬ì•„ì›ƒ: \`git fetch && git checkout ${branchName}\``
            });
