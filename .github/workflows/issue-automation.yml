name: Issue Automation
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create branch based on labels
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const labels = context.payload.issue.labels.map(label => label.name.toLowerCase());
            
            let baseBranch = 'dev';
            let branchPrefix = 'feat';

            if (labels.some(label => label.includes('hotfix'))) {
              baseBranch = 'main';
              branchPrefix = 'hotfix';
            } else if (labels.some(label => label.includes('ci'))) {
              baseBranch = 'main';
              branchPrefix = 'ci';
            } else if (labels.some(label => label.includes('cd'))) {
              baseBranch = 'main';
              branchPrefix = 'cd';
            } else if (labels.some(label => label.includes('fix'))) {
              baseBranch = 'dev';
              branchPrefix = 'fix';
            } else if (labels.some(label => label.includes('feat'))) {
              baseBranch = 'dev';
              branchPrefix = 'feat';
            }
            
            const branchName = `${branchPrefix}/${issueNumber}`;
            
            const { data: baseBranchData } = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: baseBranch
            });
            
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: baseBranchData.commit.sha
            });
            
            console.log(`Created branch: ${branchName} from ${baseBranch}`);
            
            core.exportVariable('BRANCH_NAME', branchName);
            core.exportVariable('BASE_BRANCH', baseBranch);

  suggest-pr:
    runs-on: ubuntu-latest
    needs: create-branch
    steps:
      - name: Comment PR Suggestion
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueCreator = context.payload.issue.user.login;
            const labels = context.payload.issue.labels.map(label => label.name.toLowerCase());
            
            let baseBranch = 'dev';
            let branchPrefix = 'feat';

            if (labels.some(label => label.includes('hotfix'))) {
              baseBranch = 'main';
              branchPrefix = 'hotfix';
            } else if (labels.some(label => label.includes('ci'))) {
              baseBranch = 'main';
              branchPrefix = 'ci';
            } else if (labels.some(label => label.includes('cd'))) {
              baseBranch = 'main';
              branchPrefix = 'cd';
            } else if (labels.some(label => label.includes('fix'))) {
              baseBranch = 'dev';
              branchPrefix = 'fix';
            } else if (labels.some(label => label.includes('feat'))) {
              baseBranch = 'dev';
              branchPrefix = 'feat';
            }
            
            const branchName = `${branchPrefix}/${issueNumber}`;
            
            const prTitle = '[#' + issueNumber + '] ' + issueTitle;
            const prBody = '## ğŸ“‹ Related Issue\nCloses #' + issueNumber + '\n\n## ğŸ“ Description\n' + (context.payload.issue.body || 'No description');
            
            const prUrl = 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/compare/' + baseBranch + '...' + branchName + '?expand=1&title=' + encodeURIComponent(prTitle) + '&body=' + encodeURIComponent(prBody);
            
            const commentBody = 'ğŸ‘‹ @' + issueCreator + '\n\n' +
              'âœ… ë¸Œëœì¹˜ `' + branchName + '`ê°€ `' + baseBranch + '` ë¸Œëœì¹˜ë¡œë¶€í„° ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
              'ğŸ“Œ **ë‹¤ìŒ ë‹¨ê³„:**\n' +
              '1. ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ: `git fetch && git checkout ' + branchName + '`\n' +
              '2. ì‘ì—… ì™„ë£Œ í›„ [**PR ìƒì„±í•˜ê¸°**](' + prUrl + ')\n\n' +
              'ğŸ’¡ PR ìƒì„± ì‹œ ìë™ìœ¼ë¡œ:\n' +
              '- ì´ìŠˆ #' + issueNumber + 'ì™€ ì—°ê²°ë©ë‹ˆë‹¤\n' +
              '- ' + baseBranch + ' ë¸Œëœì¹˜ë¡œ ë¨¸ì§€ë©ë‹ˆë‹¤\n' +
              '- ë¨¸ì§€ ì‹œ ì´ìŠˆê°€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤\n' +
              '- ë¸Œëœì¹˜ê°€ ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });